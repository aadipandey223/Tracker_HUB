# Design Document

## Overview

This design addresses critical bugs in the Tracker Hub application related to database operations, UI interactions, and data persistence. The fixes ensure proper UUID generation, real-time task editing, persistent finance data, and improved export functionality.

## Architecture

The application follows a React-based frontend architecture with Supabase as the backend:

- **Frontend**: React with TanStack Query for data fetching and caching
- **Backend**: Supabase PostgreSQL database with Row Level Security (RLS)
- **State Management**: React Query for server state, React hooks for local state
- **API Layer**: base44Client.supabase.js wraps Supabase operations

### Key Components

1. **Vision Board Creation**: Handles board and item creation with proper UUID generation
2. **Habit Management**: Creates and tracks habits with database constraints
3. **Task List**: Inline editing with immediate persistence
4. **Finance Module**: Monthly budget tracking with persistent total balance
5. **Export System**: CSV generation for finance data

## Components and Interfaces

### 1. Vision Board Creation Fix

**Problem**: Vision boards fail to create due to missing or invalid ID generation.

**Solution**: Ensure Supabase auto-generates UUIDs by not passing id field in create operations.

```javascript
// Before (incorrect)
const newBoard = {
  id: generateId(), // Don't pass this
  title: boardTitle,
  category: category,
  user_id: userId
};

// After (correct)
const newBoard = {
  title: boardTitle,
  category: category,
  // user_id is added by base44Client
  // id is auto-generated by Supabase
};
```

### 2. Habit Creation Fix

**Problem**: Habits fail to create with "null value in column id violates not-null constraint".

**Solution**: Remove manual ID generation and let Supabase handle UUID creation.

```javascript
// Correct approach
const createHabit = async (habitData) => {
  const { data, error } = await supabase
    .from('habits')
    .insert([{
      name: habitData.name,
      description: habitData.description,
      frequency: habitData.frequency,
      // id and user_id handled automatically
    }])
    .select()
    .single();
    
  if (error) throw error;
  return data;
};
```

### 3. Task Inline Editing

**Problem**: Task changes don't persist to database.

**Solution**: Ensure all onChange handlers call the update mutation immediately.

**Component**: `TaskList.jsx`

```javascript
// Each editable field should trigger update
<Input
  value={task.title}
  onChange={(e) => onUpdate(task.id, { title: e.target.value })}
/>

// onUpdate should call the mutation
const handleUpdateTask = (id, data) => {
  updateTask.mutate({ id, data });
};
```

### 4. Finance Total Balance Persistence

**Problem**: Total balance is stored in localStorage but not in Supabase monthly_budgets table.

**Solution**: Update the monthly_budgets table with budget_limit field.

**Schema Update Required**:
```sql
ALTER TABLE monthly_budgets 
ADD COLUMN IF NOT EXISTS budget_limit DECIMAL(10, 2) DEFAULT 0;
```

**Implementation**:
```javascript
const saveBudget = async (totalBalance, monthKey) => {
  const budgets = await base44.entities.MonthlyBudget.list();
  const existing = budgets.find(b => b.month === monthKey);
  
  if (existing) {
    await base44.entities.MonthlyBudget.update(existing.id, {
      budget_limit: totalBalance
    });
  } else {
    await base44.entities.MonthlyBudget.create({
      month: monthKey,
      category: 'general', // Required field
      budget_amount: 0,
      budget_limit: totalBalance
    });
  }
};
```

### 5. Export Function Fix

**Problem**: Export creates both CSV and JSON files, user wants only Excel-compatible file.

**Solution**: Remove JSON export code, keep only CSV generation.

```javascript
const exportData = () => {
  // Generate CSV content
  const csvData = [
    ['Finance Dashboard Export'],
    ['Month:', monthName],
    // ... rest of data
  ];
  
  const csvContent = csvData.map(row => row.join(',')).join('\n');
  const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  const url = URL.createObjectURL(blob);
  link.setAttribute('href', url);
  link.setAttribute('download', `finance_export_${monthKey}.csv`);
  link.style.visibility = 'hidden';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
  
  // Remove JSON export code entirely
};
```

### 6. Finance Chart Sizing

**Problem**: Finance charts are smaller than task tab charts.

**Solution**: Standardize chart container heights and ensure responsive sizing.

```javascript
// FinanceChart.jsx - Update ResponsiveContainer height
<ResponsiveContainer width="100%" height={400}>
  {/* Chart content */}
</ResponsiveContainer>

// Ensure parent Card has consistent styling
<Card className="bg-white dark:bg-gray-800 h-full">
  <CardHeader>...</CardHeader>
  <CardContent className="h-[400px]">
    {renderChart()}
  </CardContent>
</Card>
```

## Data Models

### Monthly Budget (Updated)

```typescript
interface MonthlyBudget {
  id: UUID;
  user_id: UUID;
  month: string; // Format: "YYYY-MM"
  category: string;
  budget_amount: number;
  spent_amount: number;
  budget_limit: number; // NEW: Total balance for the month
  created_at: timestamp;
}
```

### Vision Board

```typescript
interface VisionBoard {
  id: UUID; // Auto-generated by Supabase
  user_id: UUID; // Auto-added by base44Client
  title: string;
  category: string;
  description?: string;
  background_color: string;
  background_image?: string;
  is_archived: boolean;
  is_starred: boolean;
  tags: string[];
  theme: 'light' | 'dark' | 'gradient';
  created_date: timestamp;
}
```

### Habit

```typescript
interface Habit {
  id: UUID; // Auto-generated by Supabase
  user_id: UUID; // Auto-added by base44Client
  name: string;
  description?: string;
  frequency: string;
  target_count: number;
  color: string;
  icon: string;
  is_archived: boolean;
  created_at: timestamp;
}
```

## Correctness Properties

*A property is a characteristic or behavior that should hold true across all valid executions of a system-essentially, a formal statement about what the system should do. Properties serve as the bridge between human-readable specifications and machine-verifiable correctness guarantees.*


### Property 1: Vision board UUID validity
*For any* vision board creation operation, the created board should have a valid UUID in the id field that matches the UUID v4 format.
**Validates: Requirements 1.1**

### Property 2: Vision board required fields
*For any* vision board saved to Supabase, the record should contain all required fields including user_id, title, and category.
**Validates: Requirements 1.2**

### Property 3: Vision board creation increases list size
*For any* successful vision board creation, the user's board list length should increase by exactly one.
**Validates: Requirements 1.4**

### Property 4: Habit UUID validity
*For any* habit creation operation, the created habit should have a valid UUID in the id field.
**Validates: Requirements 2.1**

### Property 5: Habit user_id presence
*For any* habit saved to Supabase, the record should contain a non-null user_id field.
**Validates: Requirements 2.2**

### Property 6: Habit creation updates list
*For any* successful habit creation, the habits list should contain the newly created habit.
**Validates: Requirements 2.4**

### Property 7: Task title update persistence
*For any* task title change, reading the task from the database should return the updated title.
**Validates: Requirements 3.1**

### Property 8: Task priority update persistence
*For any* task priority change, the database should reflect the new priority value immediately.
**Validates: Requirements 3.2**

### Property 9: Task status update persistence
*For any* task status change, the database record should match the new status.
**Validates: Requirements 3.3**

### Property 10: Task due date update persistence
*For any* task due date change, the database should store the new date value.
**Validates: Requirements 3.4**

### Property 11: Task category update persistence
*For any* task category change, the database record should reflect the new category.
**Validates: Requirements 3.5**

### Property 12: Total balance persistence
*For any* total balance set for a month, querying the monthly_budgets table should return that balance in the budget_limit field.
**Validates: Requirements 4.1**

### Property 13: Total balance month isolation
*For any* two different months with different balances, loading each month should return its respective balance without interference.
**Validates: Requirements 4.2**

### Property 14: Total balance round-trip
*For any* total balance value saved and then reloaded, the loaded value should equal the saved value.
**Validates: Requirements 4.3**

### Property 15: Export generates only CSV
*For any* export operation, exactly one file should be generated and it should be in CSV format.
**Validates: Requirements 5.1**

### Property 16: Export filename format
*For any* export operation, the generated filename should match the pattern finance_export_YYYY-MM.csv where YYYY-MM is the current month.
**Validates: Requirements 5.3**

### Property 17: Export content completeness
*For any* export operation, the CSV content should include sections for metrics, income data, expense data, and debt data.
**Validates: Requirements 5.4**

### Property 18: Chart height consistency
*For any* set of finance charts displayed, all charts should have the same height value.
**Validates: Requirements 6.1, 6.3**

### Property 19: Dashboard data fetching
*For any* dashboard load, data fetch operations should be initiated for tasks, transactions, and debts.
**Validates: Requirements 7.1**

### Property 20: Task completion updates count
*For any* task marked as complete, the dashboard task count should decrease by one.
**Validates: Requirements 7.2**

### Property 21: Transaction addition updates summary
*For any* transaction added, the dashboard finance summary should reflect the new transaction amount.
**Validates: Requirements 7.3**

### Property 22: Error logging
*For any* failed Supabase operation, an error message should be logged to the console.
**Validates: Requirements 8.1**

## Error Handling

### Vision Board and Habit Creation Errors

- **UUID Generation**: Rely on Supabase's built-in UUID generation (uuid_generate_v4())
- **Constraint Violations**: Display user-friendly messages extracted from Supabase error responses
- **Network Errors**: Show retry button with exponential backoff

### Task Update Errors

- **Optimistic Updates**: Update UI immediately, rollback on error
- **Conflict Resolution**: Last-write-wins strategy
- **Validation**: Client-side validation before sending to server

### Finance Data Errors

- **Missing Budget**: Create default budget entry with zero values
- **Invalid Amounts**: Validate numeric inputs before saving
- **Export Failures**: Show error toast with option to retry

### Database Connection Errors

- **Authentication Failures**: Redirect to login page
- **Network Timeouts**: Show retry button with connection status
- **RLS Policy Violations**: Log user out and redirect to login

## Testing Strategy

### Unit Testing

We will use Vitest for unit testing with the following focus areas:

1. **UUID Validation**: Test that created records have valid UUIDs
2. **Data Persistence**: Test that CRUD operations correctly update the database
3. **Export Function**: Test CSV generation produces correct format and content
4. **Error Handling**: Test that errors are caught and displayed appropriately

### Property-Based Testing

We will use fast-check for property-based testing in JavaScript/TypeScript. Each correctness property will be implemented as a property-based test with a minimum of 100 iterations.

**PBT Library**: fast-check (npm package)

**Test Configuration**:
```javascript
import fc from 'fast-check';

// Example property test
fc.assert(
  fc.property(
    fc.record({
      title: fc.string(),
      category: fc.string(),
      description: fc.option(fc.string())
    }),
    async (boardData) => {
      const board = await createVisionBoard(boardData);
      // Property: board should have valid UUID
      expect(board.id).toMatch(/^[0-9a-f]{8}-[0-9a-f]{4}-4[0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i);
    }
  ),
  { numRuns: 100 }
);
```

**Property Test Requirements**:
- Each property-based test must run at least 100 iterations
- Each test must be tagged with a comment referencing the design document property
- Tag format: `// Feature: bug-fixes-comprehensive, Property X: [property description]`
- Tests should use appropriate generators for input data (strings, numbers, dates, etc.)

### Integration Testing

1. **End-to-End Flows**: Test complete user workflows (create board → add items → save)
2. **Database Integration**: Test actual Supabase operations with test database
3. **UI Integration**: Test that UI updates reflect database changes

### Manual Testing Checklist

1. Create vision board and verify it appears in list
2. Create habit and verify no console errors
3. Edit task inline and verify changes persist after page refresh
4. Set total balance, navigate away, return and verify balance is still set
5. Export finance data and verify only CSV file downloads
6. Compare chart heights between finance and task tabs
7. Check dashboard shows correct counts after adding/completing tasks
